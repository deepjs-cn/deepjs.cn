import{_ as l,o as i,c as a,V as e}from"./chunks/framework.75ed6a74.js";const r=JSON.parse('{"title":"数据埋点设计","description":"","frontmatter":{},"headers":[{"level":3,"title":"设计原则","slug":"设计原则","link":"#设计原则","children":[]},{"level":3,"title":"常见问题","slug":"常见问题","link":"#常见问题","children":[]},{"level":3,"title":"工作机制","slug":"工作机制","link":"#工作机制","children":[]},{"level":3,"title":"设计元素","slug":"设计元素","link":"#设计元素","children":[]},{"level":3,"title":"上报信息","slug":"上报信息","link":"#上报信息","children":[]},{"level":3,"title":"通用事件","slug":"通用事件","link":"#通用事件","children":[]}],"relativePath":"system-design/event-tracking/design.md","filePath":"system-design/event-tracking/design.md"}'),t={name:"system-design/event-tracking/design.md"},h=[e('<h1 id="数据埋点设计" tabindex="-1">数据埋点设计 <a class="header-anchor" href="#数据埋点设计" aria-label="Permalink to &quot;数据埋点设计&quot;">​</a></h1><p>埋点设计要解决的是收集什么场景的数据、具体收集哪些信息，如何上报这些信息，同时保证从需求到实施再到使用的合理性、工程便利性。本文将介绍埋点设计中的一些方法论和工程思路。</p><h3 id="设计原则" tabindex="-1">设计原则 <a class="header-anchor" href="#设计原则" aria-label="Permalink to &quot;设计原则&quot;">​</a></h3><p>埋点是收集数据的过程，数据最终是为业务分析和使用来服务的，因此，在埋点设计前需要分析业务对哦数据的需求。一般设计要遵循的埋点设计原则有：</p><ul><li>满足业务对数据的应用需求，包括未来可能的分析需求</li><li>一次埋点能够满足多个业务、多个分析场景的需求</li><li>设计不宜过度复杂，保证参与人员高效沟通，认知统一</li><li>设计具有可扩展性，方便更多场景的接入</li><li>减少事件数量，方便维护和问题排查</li><li>各端一致，使用统一的模型，方便实施共识和分析</li></ul><p>这里要简单介绍下埋点需要关注的信息，这里总结为由“5W2H 分析法”简化而来的“4W1H”用户行为模型：</p><ul><li>WHO：用户属性；这里包括用户本身属性（性别，年龄，籍贯等）及产品属性（会员等级，活跃度，偏好的内容类型等），因为属性本身不与行为的发生而随之改变，所以不用在埋点中体现，一般由 user_id 与用户表关联即可。</li><li>WHEN：发生行为的时间，注意不是上报时间，一般上报时间相比行为时间上会有一定的延迟。</li><li>WHERE：发生的地点。</li><li>HOW：发生行为时的一些状态，例如操作系统，网络状态，屏幕比例，分辨率等等。</li><li>WHAT：具体发生的行为，例如点击，曝光，访问等，这里会在后面的示例中展开。</li></ul><h3 id="常见问题" tabindex="-1">常见问题 <a class="header-anchor" href="#常见问题" aria-label="Permalink to &quot;常见问题&quot;">​</a></h3><p>以下是一些埋点常见的问题。</p><h4 id="什么是埋点-为什么要埋点" tabindex="-1">什么是埋点？为什么要埋点？ <a class="header-anchor" href="#什么是埋点-为什么要埋点" aria-label="Permalink to &quot;什么是埋点？为什么要埋点？&quot;">​</a></h4><p>埋点是事件跟踪工作的俗称，埋点是指对用户的行为或者系统的行为，通过技术手段，记录下相关信息，类似于开发打打印系统运行的程序日志。埋点目的是为了了解系统的运行情况，或者用户的行为细节，埋点往往是面向业务的，埋点可以超前、冗余采集数据。</p><h4 id="常见的埋点方式是什么-是怎么样的机制" tabindex="-1">常见的埋点方式是什么？是怎么样的机制？ <a class="header-anchor" href="#常见的埋点方式是什么-是怎么样的机制" aria-label="Permalink to &quot;常见的埋点方式是什么？是怎么样的机制？&quot;">​</a></h4><p>众所周知，埋点有全埋点、代码埋点、可视化埋点等几种方式，这几种埋点方面各有利弊，较大的公司一般采用的是代码埋点。代码埋点就需要开发依照数据分析需求所需要的数据，在一定的时机下进行埋点开发，采集指定的数据信息，在这个过程中，埋点的最初的动力来自业务分析需求，一般是业务运营人员的诉求，而做埋点设计（什么时机埋，要采集什么数据）是承接这些诉求的产品经理，开发人员再按埋点设计进行埋点开发，埋点功能上线后，数据流向数据分析系统、数据仓库，供数据分析人员进行处理、分析。在这个埋点为源头的数据生产消费链条中，往往有很多角色和人员参与，共同实现了公司业务的数据驱动。</p><h4 id="做埋点设计的时候-我们在设计什么" tabindex="-1">做埋点设计的时候，我们在设计什么？ <a class="header-anchor" href="#做埋点设计的时候-我们在设计什么" aria-label="Permalink to &quot;做埋点设计的时候，我们在设计什么？&quot;">​</a></h4><p>做埋点设计其实是在创建一个数据表，或者给这个数据表增加数据，这个数据表就是我们未来要查询数据的地方。期间，有两个点需要关注，一个是上报的时机，什么时候上报数据，代表着你的数据是在什么场景下得到这份数据，这与你的分析需求非常相关，你想分析的是用户的点击行为，但这份数据却是用户滑动时上报的，就不能满足你的需求；第二个是需要收集的数据信息，即事件的属性，哪些信息是你关心的，比如，我要分析用户点击的黄色按钮的次数，你就需要计下用户的 ID、按钮的颜色，以便于按按钮颜色进行筛选数据。</p><h4 id="埋点设计工作应该由谁来完成" tabindex="-1">埋点设计工作应该由谁来完成？ <a class="header-anchor" href="#埋点设计工作应该由谁来完成" aria-label="Permalink to &quot;埋点设计工作应该由谁来完成？&quot;">​</a></h4><p>假定你说的埋点设计是针对直接业务需求而进行的埋点工作，这部分最优的方案是由设计相应功能的产品经理来完成，因为埋点面对的是业务需求，同时也是产品需求的一部分，开发也依赖产品的输出进行开发工作。但是，不同团队的产品在埋点设计上能力可能有相应的差距，这时候建议团队的分析师进行辅助，即使产品有超强的埋点理解和设计能力也建议团队的分析师评审一下埋点设计，这是因为分析师清楚如果要满足业务的数据需求，需要哪些原始数据，而这些数据很可能正是由埋点而来。</p><h4 id="我的项目一定会涉及埋点吗" tabindex="-1">我的项目一定会涉及埋点吗？ <a class="header-anchor" href="#我的项目一定会涉及埋点吗" aria-label="Permalink to &quot;我的项目一定会涉及埋点吗？&quot;">​</a></h4><p>不一定。我们知道，埋点重点是在收集用户的行为过程和系统的行为，如果你的业务不关注用户的行为过程，以结果分析为主，那么很可能不需要埋点也能完成你的分析工作，解决你的需求的数据可能已经存在你的业务数据库里。例如，我想知道用户平均每月消费多少金额，你的业务库肯定（必然）会存储这些信息，那么你只需要联系数据产品经理，取得这些表在数据仓库的位置，直接进行分析。</p><h4 id="公共埋点的优缺点是什么" tabindex="-1">公共埋点的优缺点是什么？ <a class="header-anchor" href="#公共埋点的优缺点是什么" aria-label="Permalink to &quot;公共埋点的优缺点是什么？&quot;">​</a></h4><p>我们一般使用的埋点都是自定义时机、自定义属性，这些事件经由 APP、H5 端集成 SDK 提供的能力按需要进行数据上报，但公共埋点对时机、属性进行了托管，在埋点设计时，只需要选择合适时机的公共埋点并按数据模型填充数据进行上报。</p><p>简单说，公共埋点的最大做点是时机由平台统一提供，确保数据的准确性，在埋点设计、开发无需关注时机，同时数据模型一致，做到认知统一，提高了效率开发、业务数据建模效率。但缺点是对数据模型需要一定的学习，如果公司无可视化数据探索产品，需要编写 SQL。</p><h4 id="埋点设计的交付物是什么" tabindex="-1">埋点设计的交付物是什么？ <a class="header-anchor" href="#埋点设计的交付物是什么" aria-label="Permalink to &quot;埋点设计的交付物是什么？&quot;">​</a></h4><p>如果没有埋点管理系统，会按 Excel 模板填写提交，如果公司有埋点管理系统需要填写在埋点管理系统中。</p><h4 id="公共埋点事件的优缺点" tabindex="-1">公共埋点事件的优缺点 <a class="header-anchor" href="#公共埋点事件的优缺点" aria-label="Permalink to &quot;公共埋点事件的优缺点&quot;">​</a></h4><p>公共事件旨在解决以下问题：</p><ul><li>事件多，埋点设计、开发工作压力大</li><li>单个事件时机多，导致实施与需求经常出现不相符</li><li>事件重复上报、少报、漏报</li><li>场景增覆盖不全，无法得到业务线及平台全面数据</li><li>各事件数据结构不一致，导致数据开发、使用成本</li><li>各业务线数据口径不一致，经常无法做同类型事件的数据对比</li><li>对平台性数据应用如搜索、推荐、智能营销带来困扰</li><li>基于以上问题的数据不准确</li><li>曝光等体量巨大的数据无法上报</li></ul><p>公共事件基于以上问题的优点有：</p><ul><li>以时机为视角，事件原子化，不设复杂的上报条件，做到全业务线统一</li><li>上报时机交由平台底层实现，不依赖各业务开发</li><li>各业务接入时，只关注数据的绑定填充，无需要关注时机</li><li>产品设计埋点时只按模型关注有限的上服数据取值</li><li>统一数据模型，从设计、开发、使用做到一致，降低沟通成本</li><li>做到全平台统一，数据口径一致</li><li>为平台性数据应用如搜索、推荐、智能营销等提供统一数据</li><li>一般支持支持海量数据的上报</li><li>一般支持实时数据</li></ul><p>公共事件的主要挑战有：</p><ul><li>在参与公共事件前需要进行学习，有一定抽象理解能力</li><li>目前数据的查询提取没有友好的数据探索能力</li><li>设计文档表现上很验证做到比较直观</li></ul><p>对应挑战的解决方法：</p><ul><li>在首次参与公共事件的产品、分析师、研发、测试、运营等人员需要进行学习了解</li><li>数据团队定期会有相关培训，帮助大家理解</li><li>用数人员使用 SQL 查询工具编写 SQL 查询对应数据</li><li>数据团队会逐渐建设数据查询平台，补充一定可视化查询能力</li><li>埋点设计文档与 wiki 结合，对新参与同事多做宣讲、指导</li></ul><h3 id="工作机制" tabindex="-1">工作机制 <a class="header-anchor" href="#工作机制" aria-label="Permalink to &quot;工作机制&quot;">​</a></h3><p>埋点工作参与的团队：</p><ul><li>需求方：此为数据的需求方，并非埋点的需求方，包括业务运营和产品经理以及数据分析师，一般会提出对数据的需求，埋点设计要根据这些需求进行设计。还有开发测试团队基于技术监控、问题排查等需要也会成为需求方</li><li>数据产品经理：埋点的设计者，设计埋点的规范或者埋点的实例细节</li><li>研发：包括前端研发和后端研发，是埋点的开发实施者，这里分为埋点规范的研发、埋点接收服务的研发、业务接入的研发</li><li>测试：埋点的测试（上线前）、验证（上线后）工作</li><li>数据开发：埋点数据的清洗、建模</li><li>数据分析师：埋点数据的使用者</li></ul><p>下图是关于埋点团队协作流程的最佳实践：</p><p><img src="/assets/event-tracking-1.6253c45b.jpg" alt="埋点团队协作流程"></p><h3 id="设计元素" tabindex="-1">设计元素 <a class="header-anchor" href="#设计元素" aria-label="Permalink to &quot;设计元素&quot;">​</a></h3><p>埋点最核心的其实是两点：</p><ul><li>什么时候：时机</li><li>上报什么信息：属性</li></ul><p>以上就是两个重要元素的对象：事件。</p><p>我们把所有的数据上报抽象为事件，这些事件不论谁，无论上报什么信息。</p><p>埋点设计一般有两种思路，一个是基于时机，一个是基于事件。时机关注埋点发生的源动力、行为本身，事件关注事件的结果，影响。</p><p>相对来说，时机更加抽象，事件更加具体。</p><h4 id="时机" tabindex="-1">时机 <a class="header-anchor" href="#时机" aria-label="Permalink to &quot;时机&quot;">​</a></h4><p>时机就是事件场景，因什么而发生，发生了什么，由谁来触发。触发者可以是用户、系统、运营人员，本质还是系统，系统是事件发生的代理者。一个时机应该包含以上的隐含信息。</p><p>常见的时机有：</p><ul><li>点击</li><li>浏览（访问）</li><li>曝光</li><li>播放</li><li>结果</li><li>等</li></ul><h4 id="事件" tabindex="-1">事件 <a class="header-anchor" href="#事件" aria-label="Permalink to &quot;事件&quot;">​</a></h4><p>事件往往站在结果的角度，对业务的影响，更加业务化。这时，事件不会过于关注埋点的触发场景，更多的聚焦在业务结果上。因此，事件往往有很多的时机，多种时机会产生一个事件。</p><p>常见的事件有：</p><ul><li>关注</li><li>购买</li><li>收藏</li><li>下载</li><li>播放</li><li>曝光</li><li>等等</li></ul><p>我们发现，上边很多事件其实都是由「点击」而来的。</p><h3 id="上报信息" tabindex="-1">上报信息 <a class="header-anchor" href="#上报信息" aria-label="Permalink to &quot;上报信息&quot;">​</a></h3><p>埋点上报的信息一般分为：</p><ul><li>公共信息：一般为用户的全局信息，包含设备、网络、个人、页面、位置模块、时间等与业务无关的通用信息</li><li>业务公共信息：一般为主数据信息，商品、内容、订单等与业务内容相关的信息，一般为企业多个业务共用的信息</li><li>自定义信息：业务内容的信息</li><li>扩展信息：特殊场景下上报的信息</li></ul><p>此外还有一些额外的通用模型信息：</p><ul><li>spm</li><li>scm</li><li>utm</li></ul><p>以下是一个埋点设计表：</p><p><img src="/assets/event-tracking-design-1.054739ab.jpg" alt="埋点设计表"></p><h4 id="公共信息" tabindex="-1">公共信息 <a class="header-anchor" href="#公共信息" aria-label="Permalink to &quot;公共信息&quot;">​</a></h4><p>埋点信息：</p><ul><li>SDK 版本</li><li>事件产生的时间</li><li>服务端接收的时间</li><li>本次启动的时间</li><li>Sessionid</li></ul><p>用户信息：</p><ul><li>账号 ID</li><li>用户昵称</li><li>idfa/imei md5 加密值</li><li>设备 id</li><li>是否首日访问</li><li>国家</li><li>城市</li><li>省份</li><li>县区</li><li>会员等级</li></ul><p>设备信息：</p><ul><li>操作系统</li><li>操作系统版本</li><li>手机型号</li><li>设备制造商</li><li>设备型号</li><li>屏幕高度</li><li>屏幕宽度</li><li>经度</li><li>纬度</li><li>深色模式</li><li>是否 WiFi</li><li>网络类型</li><li>运营商名称</li><li>IP</li><li>UA 信息</li></ul><p>应用信息：</p><ul><li>是否是灰度版本</li><li>当前渠道</li><li>应用内部版本号</li><li>AB 测试标识</li><li>实验 ID</li><li>包名</li><li>是否青少年模式</li><li>夜间模式</li><li>位置是否授权</li><li>提醒是否开启</li><li>安装渠道</li></ul><h4 id="位置信息" tabindex="-1">位置信息 <a class="header-anchor" href="#位置信息" aria-label="Permalink to &quot;位置信息&quot;">​</a></h4><p>互联网产品，特别是面向 C 端的产品，在内容呈现方面往往以区块为主体分隔，在区块中展现具体的业务内容。模块是指在展示界面中展示一批具体内容的区域。这些区域内部来看，往往承载了相同性质的内容，如视频、文章、商品等，或者表达了一种聚合方式，如推荐模块中的内容类型可能是混杂的，但此模块则表示模块中的内容全部来自于推荐。</p><p>在模块的外部来看，不同模块代表了不同的内容类型，或是不同的内容维度。</p><p>模块的编码：模块的顺序一般是从左到右，从上到下，并对界面中所有的内容全部（包括弹窗、默认隐藏内容等）纳入编码范围。</p><p>界面信息：</p><ul><li>当前页面</li><li>当前 URL</li><li>URL 参数</li><li>当前 URI</li><li>上一页</li><li>页面标题</li><li>形式 (原生/H5)</li></ul><p>界面层级：</p><ul><li>一级</li><li>二级</li><li>三级</li><li>四级</li></ul><p>模块信息：</p><ul><li>模块名称</li><li>父模块名称</li><li>模块位置顺序</li></ul><h4 id="内容模型" tabindex="-1">内容模型 <a class="header-anchor" href="#内容模型" aria-label="Permalink to &quot;内容模型&quot;">​</a></h4><p>内容是指在模块中展示的业务实体（如视频、文章、商品、用户等）、交互元素（如按钮、输入框、广告位等）。业务实体一般会动态变化，会按业务逻辑更新或者按用户进行随机推荐，交互元素一般为固定的内容，具体内容不会变化。</p><p>内容的编码：业务实体从 0 开始编码，交互元素单独起名。</p><p>内容：</p><ul><li>内容类型</li><li>内容名称</li><li>内容 ID</li><li>父内容 ID</li></ul><h4 id="其他信息" tabindex="-1">其他信息 <a class="header-anchor" href="#其他信息" aria-label="Permalink to &quot;其他信息&quot;">​</a></h4><ul><li>推荐信息</li><li>扩展信息</li></ul><h3 id="通用事件" tabindex="-1">通用事件 <a class="header-anchor" href="#通用事件" aria-label="Permalink to &quot;通用事件&quot;">​</a></h3><p>为了满足任意场景的需求，可以设计一个通用的埋点模型，时机由上报方自行决定，除了公共信息外用以下属性加以区分：</p><ul><li>结果名称：产生结果的名称，如：发生支付行为</li><li>结果类型：产生结果的类型，如：支付成功、支付失败</li></ul><p>其余字段均为自定义属性，有几种设计方式，一为（属性名和值成对）：</p><ul><li>属性 1 名</li><li>属性 1 的值</li><li>属性 2 名</li><li>属性 2 的值</li><li>属性 3 名</li><li>属性 3 的值</li><li>属性 4 名</li><li>属性 5 的值</li><li>...</li></ul><p>还有一种方式是（属性值，自己记住不同位的取值意义）：</p><ul><li>属性 1</li><li>属性 2</li><li>属性 3</li><li>属性 4</li><li>属性 5</li><li>...</li></ul><p>还有一种是（将数据属性上报为是 json 格式）：</p><ul><li>json string</li></ul><p>其他</p><p>关于视频，统计播放情况，可周期性上报心跳。</p><p>参考</p><ul><li><a href="https://mp.weixin.qq.com/s/7i7kBGEuW3bJ9Insaf_-mA" target="_blank" rel="noreferrer">https://mp.weixin.qq.com/s/7i7kBGEuW3bJ9Insaf_-mA</a></li><li><a href="https://mp.weixin.qq.com/s/3_CohsOkk6kd2st1b_T81w" target="_blank" rel="noreferrer">https://mp.weixin.qq.com/s/3_CohsOkk6kd2st1b_T81w</a></li></ul>',100)];const p=l(t,[["render",function(l,e,r,t,p,n){return i(),a("div",null,h)}]]);export{r as __pageData,p as default};
